{% extends "base.html" %}

{% block title %}{{ athlete.first_name }} {{ athlete.last_name }} - Cross Country Stats{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>
            {% if athlete.gender == 'male' %}
                <i class="fas fa-male text-primary"></i>
            {% else %}
                <i class="fas fa-female text-danger"></i>
            {% endif %}
            {{ athlete.first_name }} {{ athlete.last_name }}
        </h1>
        <p class="lead">
            {% if athlete.graduation_year %}
                Class of {{ athlete.graduation_year }} •
            {% endif %}
            {{ athlete.gender.title() }} • {{ varsity_races }} Varsity Race{{ 's' if varsity_races != 1 else '' }}
        </p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('athletes_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Athletes
        </a>
    </div>
</div>

<!-- Personal Records -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-trophy text-warning"></i> Personal Records</h3>
        {% if prs %}
        <div class="row">
            {% for pr in prs %}
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ pr.distance }}</h5>
                        <h2 class="card-text time-display text-primary">
                            {{ format_time(pr.pr_seconds) }}
                        </h2>
                        <p class="pace-display text-success mb-2">
                            <strong>{{ calculate_pace(pr.pr_seconds, pr.distance) }} pace</strong>
                        </p>
                        <p class="text-muted">
                            <small>{{ pr.race_count }} race{{ 's' if pr.race_count != 1 else '' }}</small>
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No personal records found.
        </div>
        {% endif %}
    </div>
</div>

<!-- Race Results -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-list text-info"></i> Race Results</h3>
        {% if results %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Meet</th>
                                <th>Race</th>
                                <th>Distance</th>
                                <th>Class</th>
                                <th>Time</th>
                                <th>Pace</th>
                                <th>Place</th>
                                <th>Venue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.meet_date }}</td>
                                <td>{{ result.meet_name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ result.race_name }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ result.distance }}</span>
                                </td>
                                <td>
                                    {% if result.race_class == 'varsity' %}
                                        <span class="badge bg-primary">Varsity</span>
                                    {% elif result.race_class == 'jv' %}
                                        <span class="badge bg-success">JV</span>
                                    {% elif result.race_class == 'freshman' %}
                                        <span class="badge bg-info">Frosh</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ result.race_class.title() }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="time-display text-primary">
                                        {{ format_time(result.time_seconds) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="pace-display text-success">
                                        {{ calculate_pace(result.time_seconds, result.distance) }}
                                    </span>
                                </td>
                                <td>
                                    {% if result.place <= 3 %}
                                        <span class="badge bg-warning text-dark">{{ result.place }}</span>
                                    {% elif result.place <= 10 %}
                                        <span class="badge bg-success">{{ result.place }}</span>
                                    {% else %}
                                        {{ result.place }}
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ result.venue_name or 'N/A' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No race results found for this athlete.
        </div>
        {% endif %}
    </div>
</div>

<!-- Progress Charts for each distance -->
<div class="row">
    <div class="col-12">
        <h3><i class="fas fa-chart-line text-success"></i> Progress Over Time</h3>
        <div class="card mb-3">
            <div class="card-header">
                <h5>All Races Progress</h5>
            </div>
            <div class="card-body">
                <div id="progress-chart-all" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch progress data for all races
    console.log('DEBUG: Chart version 2.0 - Using athlete_id:', '{{ athlete_id }}');
    console.log('Fetching data from: /api/athlete/{{ athlete_id }}/progress/all');
    fetch('/api/athlete/{{ athlete_id }}/progress/all')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.length > 0) {
                const dates = data.map(d => d.date);
                const fivek_times = data.map(d => d.five_k_time);
                const formatted_fivek_times = data.map(d => d.formatted_five_k_time);
                const paces = data.map(d => d.pace_seconds);
                const meets = data.map(d => d.meet);
                const formatted_paces = data.map(d => d.pace);

                console.log('DEBUG - 5K times:', fivek_times);
                console.log('DEBUG - Paces:', paces);
                console.log('DEBUG - Dates:', dates);
                console.log('DEBUG - 5K time range:', Math.min(...fivek_times), 'to', Math.max(...fivek_times));
                console.log('DEBUG - Pace range:', Math.min(...paces), 'to', Math.max(...paces));

                // Helper function to format seconds to MM:SS
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return minutes + ':' + (secs < 10 ? '0' : '') + secs;
                }

                // 5k Time trace (primary y-axis)
                const fivekTrace = {
                    x: dates,
                    y: fivek_times,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#007bff', width: 4},
                    marker: {size: 12, color: '#007bff'},
                    name: '5k Time',
                    text: meets,
                    hovertemplate: '<b>%{text}</b><br>Date: %{x}<br>5k Time: %{customdata}<extra></extra>',
                    customdata: fivek_times.map(formatTime),
                    yaxis: 'y'
                };

                // Pace trace (secondary y-axis)
                const paceTrace = {
                    x: dates,
                    y: paces,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {color: '#28a745', width: 4, dash: 'dash'},
                    marker: {size: 12, color: '#28a745', symbol: 'square'},
                    name: 'Pace per Mile',
                    text: meets,
                    hovertemplate: '<b>%{text}</b><br>Date: %{x}<br>Pace: %{customdata}/mile<extra></extra>',
                    customdata: paces.map(formatTime),
                    yaxis: 'y2'
                };

                console.log('DEBUG - fivekTrace:', fivekTrace);
                console.log('DEBUG - paceTrace:', paceTrace);

                const layout = {
                    title: {
                        text: 'All Races Performance Over Time',
                        font: {size: 16}
                    },
                    xaxis: {
                        title: 'Date',
                        type: 'date'
                    },
                    yaxis: {
                        title: '5k Time',
                        titlefont: {color: '#007bff'},
                        tickfont: {color: '#007bff'},
                        side: 'left',
                        range: [Math.min(...fivek_times) * 0.98, Math.max(...fivek_times) * 1.02],
                        tickmode: 'array',
                        tickvals: [],
                        ticktext: []
                    },
                    yaxis2: {
                        title: 'Pace per Mile',
                        titlefont: {color: '#28a745'},
                        tickfont: {color: '#28a745'},
                        side: 'right',
                        overlaying: 'y',
                        // Offset pace axis up by 10% from baseline
                        range: [Math.min(...paces) * 0.9, Math.max(...paces) * 1.1],
                        tickmode: 'array',
                        tickvals: [],
                        ticktext: []
                    },
                    hovermode: 'x unified',
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.8)',
                        bordercolor: 'rgba(0,0,0,0.2)',
                        borderwidth: 1
                    }
                };

                // Generate MM:SS tick labels for 5k times (y-axis)
                const minFiveK = Math.min(...fivek_times) * 0.98;
                const maxFiveK = Math.max(...fivek_times) * 1.02;
                const fiveKStep = (maxFiveK - minFiveK) / 6; // About 6 ticks
                for (let i = 0; i <= 6; i++) {
                    const val = minFiveK + (i * fiveKStep);
                    layout.yaxis.tickvals.push(val);
                    layout.yaxis.ticktext.push(formatTime(val));
                }

                // Generate MM:SS tick labels for pace (y2-axis)  
                const minPace = Math.min(...paces) * 0.9;
                const maxPace = Math.max(...paces) * 1.1;
                const paceStep = (maxPace - minPace) / 6; // About 6 ticks
                for (let i = 0; i <= 6; i++) {
                    const val = minPace + (i * paceStep);
                    layout.yaxis2.tickvals.push(val);
                    layout.yaxis2.ticktext.push(formatTime(val));
                }

                console.log('DEBUG - Layout:', layout);

                console.log('DEBUG - Creating chart with traces...');

                Plotly.newPlot('progress-chart-all', [fivekTrace, paceTrace], layout)
                    .then(() => {
                        console.log('Chart created successfully');
                    })
                    .catch(error => {
                        console.error('Error creating chart:', error);
                    });
            } else {
                console.log('No data received for chart');
            }
        })
        .catch(error => {
            console.error('Error fetching progress data:', error);
        });
});
</script>
{% endblock %}
